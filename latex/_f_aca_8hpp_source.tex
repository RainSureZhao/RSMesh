\doxysection{FAca.\+hpp}
\hypertarget{_f_aca_8hpp_source}{}\label{_f_aca_8hpp_source}\index{third\_party/ScalFMM/include/ScalFMM/Utils/FAca.hpp@{third\_party/ScalFMM/include/ScalFMM/Utils/FAca.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ See\ LICENCE\ file\ at\ project\ root}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#ifndef\ FACA\_HPP}}
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#define\ FACA\_HPP}}
\DoxyCodeLine{00004\ }
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}FGlobal.hpp"{}}}
\DoxyCodeLine{00006\ }
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ "{}FSvd.hpp"{}}}
\DoxyCodeLine{00008\ }
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00016\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{class_f_aca}{FAca}}\ \{}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00033\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{class}\ FReal>}
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{keywordtype}{void}\ fACA(FReal\ *\textcolor{keyword}{const}\ K,}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ nx,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ ny,}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{double}\ eps,\ FReal*\ \&U,\ FReal*\ \&V,\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \&k)}
\DoxyCodeLine{00037\ \ \ \ \ \{}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ control\ vectors\ (true\ if\ not\ used,\ false\ if\ used)}}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ *\textcolor{keyword}{const}\ r\ =\ \textcolor{keyword}{new}\ \textcolor{keywordtype}{bool}[nx];}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ *\textcolor{keyword}{const}\ c\ =\ \textcolor{keyword}{new}\ \textcolor{keywordtype}{bool}[ny];}
\DoxyCodeLine{00041\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ i=0;\ i<nx;\ ++i)\ r[i]\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ j=0;\ j<ny;\ ++j)\ c[j]\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ compute\ Frobenius\ norm\ of\ original\ Matrix\ K}}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ FReal\ norm2K\ =\ 0;}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ j=0;\ j<ny;\ ++j)\ \{}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ FReal\ *\textcolor{keyword}{const}\ colK\ =\ K\ +\ j*nx;}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \ \ \ \ norm2K\ +=\ FBlas::scpr(nx,\ colK,\ colK);}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ initialize\ rank\ k\ and\ UV'}}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ k\ =\ 0;}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ maxk\ =\ (nx\ +\ ny)\ /\ 2;}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ U\ =\ \textcolor{keyword}{new}\ FReal[nx\ *\ maxk];}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ V\ =\ \textcolor{keyword}{new}\ FReal[ny\ *\ maxk];}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ FBlas::setzero(nx*maxk,\ U);}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ FBlas::setzero(ny*maxk,\ V);}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ FReal\ norm2R;}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ start\ fully\ pivoted\ ACA}}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ find\ max(K)\ and\ argmax(K)}}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ maxK\ =\ 0.;}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ pi=0,\ pj=0;}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ j=0;\ j<ny;\ ++j)}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (c[j])\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ FReal\ *\textcolor{keyword}{const}\ colK\ =\ K\ +\ j*nx;}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ i=0;\ i<nx;\ ++i)}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (r[i]\ \&\&\ maxK\ <\ \mbox{\hyperlink{struct_f_math_ac005cd270abc850853ba71d1e38a2f28}{FMath::Abs}}(colK[i]))\ \{}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ maxK\ =\ \mbox{\hyperlink{struct_f_math_ac005cd270abc850853ba71d1e38a2f28}{FMath::Abs}}(colK[i]);}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pi\ =\ i;\ }
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pj\ =\ j;}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ copy\ pivot\ cross\ into\ U\ and\ V}}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ colU\ =\ U\ +\ k*nx;}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ colV\ =\ V\ +\ k*ny;}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ FReal\ pivot\ =\ K[pj*nx\ +\ pi];}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ i=0;\ i<nx;\ ++i)\ \textcolor{keywordflow}{if}\ (r[i])\ colU[i]\ =\ K[pj*nx\ +\ i];}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ j=0;\ j<ny;\ ++j)\ \textcolor{keywordflow}{if}\ (c[j])\ colV[j]\ =\ K[j\ *nx\ +\ pi]\ /\ pivot;}
\DoxyCodeLine{00084\ }
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ don't\ use\ these\ cols\ and\ rows\ anymore}}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ c[pj]\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ r[pi]\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ subtract\ k-\/th\ outer\ product\ from\ K}}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ j=0;\ j<ny;\ ++j)}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (c[j])\ \{}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ colK\ =\ K\ +\ j*nx;}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FBlas::axpy(nx,\ FReal(-\/1.\ *\ colV[j]),\ colU,\ colK);}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ compute\ Frobenius\ norm\ of\ updated\ K}}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ norm2R\ =\ 0.0;}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ j=0;\ j<ny;\ ++j)}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (c[j])\ \{}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ FReal\ *\textcolor{keyword}{const}\ colK\ =\ K\ +\ j*nx;}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ norm2R\ +=\ FBlas::scpr(nx,\ colK,\ colK);}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ increment\ rank\ k}}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ ++k\ ;}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{while}\ (norm2R\ >\ eps*eps\ *\ norm2K);}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ r;}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ c;}
\DoxyCodeLine{00112\ \ \ \ \ \}}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ }
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ }
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ }
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00140\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{class}\ FReal,\ \textcolor{keyword}{typename}\ ComputerType>}
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keywordtype}{void}\ pACA(\textcolor{keyword}{const}\ ComputerType\&\ Computer,}
\DoxyCodeLine{00142\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ nx,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ ny,}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ FReal\ eps,\ FReal*\ \&U,\ FReal*\ \&V,\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \&k)}
\DoxyCodeLine{00144\ \ \ \ \ \{}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ control\ vectors\ (true\ if\ not\ used,\ false\ if\ used)}}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ *\textcolor{keyword}{const}\ r\ =\ \textcolor{keyword}{new}\ \textcolor{keywordtype}{bool}[nx];}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ *\textcolor{keyword}{const}\ c\ =\ \textcolor{keyword}{new}\ \textcolor{keywordtype}{bool}[ny];}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ i=0;\ i<nx;\ ++i)\ r[i]\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ j=0;\ j<ny;\ ++j)\ c[j]\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00151\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ initialize\ rank\ k\ and\ UV'}}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ k\ =\ 0;}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ FReal\ eps2\ =\ eps\ *\ eps;}
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ maxk\ =\ (nx\ +\ ny)\ /\ 2;}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ U\ =\ \textcolor{keyword}{new}\ FReal[nx\ *\ maxk];}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ V\ =\ \textcolor{keyword}{new}\ FReal[ny\ *\ maxk];}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ initialize\ norm}}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ FReal\ norm2S(0.);}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ FReal\ norm2uv(0.);}
\DoxyCodeLine{00161\ }
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ start\ partially\ pivoted\ ACA}}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ J\ =\ 0,\ I\ =\ 0;}
\DoxyCodeLine{00165\ }
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ colU\ =\ U\ +\ nx*k;}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ colV\ =\ V\ +\ ny*k;}
\DoxyCodeLine{00169\ }
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ compute\ row\ I\ and\ its\ residual}}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \ \ \ \ Computer(I,\ I+1,\ 0,\ ny,\ colV);}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ \ \ \ \ r[I]\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ l=0;\ l<k;\ ++l)\ \{}
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ u\ =\ U\ +\ nx*l;}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ v\ =\ V\ +\ ny*l;}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FBlas::axpy(ny,\ FReal(-\/1.\ *\ u[I]),\ v,\ colV);}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00179\ }
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ find\ max\ of\ residual\ and\ argmax}}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ maxval\ =\ 0.;}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ j=0;\ j<ny;\ ++j)\ \{}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ FReal\ abs\_val\ =\ \mbox{\hyperlink{struct_f_math_ac005cd270abc850853ba71d1e38a2f28}{FMath::Abs}}(colV[j]);}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (c[j]\ \&\&\ maxval\ <\ abs\_val)\ \{}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ maxval\ =\ abs\_val;}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ J\ =\ j;}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ find\ pivot\ and\ scale\ column\ of\ V}}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ FReal\ pivot\ =\ FReal(1.)\ /\ colV[J];}
\DoxyCodeLine{00191\ \ \ \ \ \ \ \ \ \ \ \ \ FBlas::scal(ny,\ pivot,\ colV);}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00194\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ compute\ col\ J\ and\ its\ residual}}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \ \ \ \ Computer(0,\ nx,\ J,\ J+1,\ colU);}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ \ \ \ \ c[J]\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00197\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ l=0;\ l<k;\ ++l)\ \{}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ u\ =\ U\ +\ nx*l;}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ v\ =\ V\ +\ ny*l;}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FBlas::axpy(nx,\ FReal(-\/1.\ *\ v[J]),\ u,\ colU);}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ find\ max\ of\ residual\ and\ argmax}}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \ \ \ \ maxval\ =\ 0.0;}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ i=0;\ i<nx;\ ++i)\ \{}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ FReal\ abs\_val\ =\ \mbox{\hyperlink{struct_f_math_ac005cd270abc850853ba71d1e38a2f28}{FMath::Abs}}(colU[i]);}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (r[i]\ \&\&\ maxval\ <\ abs\_val)\ \{}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ maxval\ =\ abs\_val;}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ I\ =\ i;}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ increment\ Frobenius\ norm:\ |Sk|\string^2\ +=\ |uk|\string^2\ |vk|\string^2\ +\ 2\ sumj\ ukuj\ vjvk}}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ normuuvv(0.);}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ l=0;\ l<k;\ ++l)}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ normuuvv\ +=\ FBlas::scpr(nx,\ colU,\ U\ +\ nx*l)\ *\ FBlas::scpr(ny,\ V\ +\ ny*l,\ colV);}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ \ \ \ \ norm2uv\ =\ FBlas::scpr(nx,\ colU,\ colU)\ *\ FBlas::scpr(ny,\ colV,\ colV);}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ \ \ \ \ norm2S\ +=\ norm2uv\ +\ 2*normuuvv;}
\DoxyCodeLine{00220\ }
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ increment\ low-\/rank}}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ ++k;}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{while}\ (norm2uv\ >\ eps2\ *\ norm2S);}
\DoxyCodeLine{00226\ }
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ r;}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ c;}
\DoxyCodeLine{00229\ \ \ \ \ \}}
\DoxyCodeLine{00230\ }
\DoxyCodeLine{00231\ }
\DoxyCodeLine{00244\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{class}\ FReal>}
\DoxyCodeLine{00245\ \ \ \ \ \textcolor{keywordtype}{void}\ recompress(FReal\ *\textcolor{keyword}{const}\ UU,\ FReal\ *\textcolor{keyword}{const}\ VV,\ }
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ nx,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ ny,}
\DoxyCodeLine{00247\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{double}\ eps,\ FReal*\ \&U,\ FReal*\ \&VT,\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \&rank)}
\DoxyCodeLine{00248\ \ \ \ \ \{}
\DoxyCodeLine{00249\ }
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ needed\ for\ the\ SVD}}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ INFO;}
\DoxyCodeLine{00252\ }
\DoxyCodeLine{00253\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ QR\ decomposition\ (UU=QuRu\ \&\ VV=QvRv,\ thus\ UUVV\string^t=Qu(RuRv\string^t)Qv\string^t)}}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ FReal*\ phi\ =\ \textcolor{keyword}{new}\ FReal\ [rank*rank];}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00256\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ needed\ for\ QR}}
\DoxyCodeLine{00257\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ LWORK\ =\ 2*4*rank;\ \textcolor{comment}{//\ for\ square\ matrices}}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//const\ unsigned\ int\ LWORK\ =\ 2*std::max(3*minMN+maxMN,\ 5*minMN);}}
\DoxyCodeLine{00259\ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ WORK\ =\ \textcolor{keyword}{new}\ FReal\ [LWORK];}
\DoxyCodeLine{00260\ }
\DoxyCodeLine{00261\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ QR\ of\ U\ and\ V}}
\DoxyCodeLine{00262\ \ \ \ \ \ \ \ \ \ \ \ \ FReal*\ tauU\ =\ \textcolor{keyword}{new}\ FReal\ [rank];}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \ \ \ \ \ \ INFO\ =\ FBlas::geqrf(nx,\ rank,\ UU,\ tauU,\ LWORK,\ WORK);}
\DoxyCodeLine{00264\ \ \ \ \ \ \ \ \ \ \ \ \ assert(INFO==0);}
\DoxyCodeLine{00265\ \ \ \ \ \ \ \ \ \ \ \ \ FReal*\ tauV\ =\ \textcolor{keyword}{new}\ FReal\ [rank];}
\DoxyCodeLine{00266\ \ \ \ \ \ \ \ \ \ \ \ \ INFO\ =\ FBlas::geqrf(ny,\ rank,\ VV,\ tauV,\ LWORK,\ WORK);}
\DoxyCodeLine{00267\ \ \ \ \ \ \ \ \ \ \ \ \ assert(INFO==0);}
\DoxyCodeLine{00268\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ phi\ =\ Ru\ Rv'}}
\DoxyCodeLine{00269\ \ \ \ \ \ \ \ \ \ \ \ \ FReal*\ rU\ =\ \textcolor{keyword}{new}\ FReal\ [2\ *\ rank*rank];}
\DoxyCodeLine{00270\ \ \ \ \ \ \ \ \ \ \ \ \ FReal*\ rV\ =\ rU\ +\ rank*rank;}
\DoxyCodeLine{00271\ \ \ \ \ \ \ \ \ \ \ \ \ FBlas::setzero(2\ *\ rank*rank,\ rU);}
\DoxyCodeLine{00272\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ l=0;\ l<rank;\ ++l)\ \{}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FBlas::copy(l+1,\ UU\ +\ l*nx,\ rU\ +\ l*rank);}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FBlas::copy(l+1,\ VV\ +\ l*ny,\ rV\ +\ l*rank);}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00276\ \ \ \ \ \ \ \ \ \ \ \ \ FBlas::gemmt(rank,\ rank,\ rank,\ FReal(1.),\ rU,\ rank,\ rV,\ rank,\ phi,\ rank);}
\DoxyCodeLine{00277\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ rU;}
\DoxyCodeLine{00278\ }
\DoxyCodeLine{00279\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ get\ Qu\ and\ Qv}}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \ \ \ \ \ \ INFO\ =\ FBlas::orgqr(nx,\ rank,\ UU,\ tauU,\ LWORK,\ WORK);\ \textcolor{comment}{//\ Qu\ -\/>\ UU}}
\DoxyCodeLine{00281\ \ \ \ \ \ \ \ \ \ \ \ \ assert(INFO==0);}
\DoxyCodeLine{00282\ \ \ \ \ \ \ \ \ \ \ \ \ INFO\ =\ FBlas::orgqr(ny,\ rank,\ VV,\ tauV,\ LWORK,\ WORK);\ \textcolor{comment}{//\ Qv\ -\/>\ VV}}
\DoxyCodeLine{00283\ \ \ \ \ \ \ \ \ \ \ \ \ assert(INFO==0);}
\DoxyCodeLine{00284\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ tauU;}
\DoxyCodeLine{00285\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ tauV;}
\DoxyCodeLine{00286\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00287\ }
\DoxyCodeLine{00288\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ aca\_rank\ =\ rank;}
\DoxyCodeLine{00289\ }
\DoxyCodeLine{00290\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ SVD\ (of\ phi=RuRv\string^t,\ thus\ phi=UrSVr\string^t)}}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ VrT\ =\ \textcolor{keyword}{new}\ FReal\ [aca\_rank*aca\_rank];}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ Sr\ =\ \textcolor{keyword}{new}\ FReal\ [aca\_rank];}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ needed\ for\ SVD}}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ LWORK\ =\ 2*4*aca\_rank;\ \textcolor{comment}{//\ for\ square\ matrices}}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//const\ unsigned\ int\ LWORK\ =\ 2*std::max(3*minMN+maxMN,\ 5*minMN);}}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \ \ \ \ FReal\ *\textcolor{keyword}{const}\ WORK\ =\ \textcolor{keyword}{new}\ FReal\ [LWORK];}
\DoxyCodeLine{00298\ }
\DoxyCodeLine{00299\ \ \ \ \ \ \ \ \ \ \ \ \ INFO\ =\ FBlas::gesvd(aca\_rank,\ aca\_rank,\ phi,\ Sr,\ VrT,\ aca\_rank,\ LWORK,\ WORK);\ \textcolor{comment}{//\ Ur\ -\/>\ phi\ //\ Sr\ -\/>\ Sr\ //\ Vr\string^t\ -\/>\ VrT}}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (INFO!=0)\{}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::stringstream\ stream;}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ stream\ <<\ INFO;}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}SVD\ did\ not\ converge\ with\ "{}}\ +\ stream.str());}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00305\ \ \ \ \ \ \ \ \ \ \ \ \ rank\ =\ FSvd::getRank(Sr,\ aca\_rank,\ eps);}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00307\ }
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ store\ Qu(UrS)\ in\ U\ and\ Vr\string^t(Qv\string^t)\ in\ VT}}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ allocate}}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \ \ \ \ assert(U\ ==\textcolor{keyword}{nullptr});}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ \ \ \ \ assert(VT==\textcolor{keyword}{nullptr});}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \ \ \ \ U\ \ =\ \textcolor{keyword}{new}\ FReal[rank*nx];}
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ \ \ \ \ VT\ =\ \textcolor{keyword}{new}\ FReal[rank*ny];}
\DoxyCodeLine{00315\ }
\DoxyCodeLine{00316\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ (Ur\ Sigma)}}
\DoxyCodeLine{00317\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ r=0;\ r<rank;\ ++r)}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FBlas::scal(aca\_rank,\ Sr[r],\ phi\ +\ r*aca\_rank);}
\DoxyCodeLine{00319\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ Sr;}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00321\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Qu\ (Ur\ Sr)\ in\ U}}
\DoxyCodeLine{00322\ \ \ \ \ \ \ \ \ \ \ \ \ FBlas::gemm(nx,\ aca\_rank,\ rank,\ FReal(1.),\ UU,\ nx,\ phi,\ aca\_rank,\ U,\ nx);}
\DoxyCodeLine{00323\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ phi;}
\DoxyCodeLine{00324\ }
\DoxyCodeLine{00325\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ VT=Vr\string^t\ Qv\string^t}}
\DoxyCodeLine{00326\ \ \ \ \ \ \ \ \ \ \ \ \ FBlas::gemmt(rank,\ aca\_rank,\ ny,\ FReal(1.),\ VrT,\ aca\_rank,\ VV,\ ny,\ VT,\ rank);}
\DoxyCodeLine{00327\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{delete}\ []\ VrT;}
\DoxyCodeLine{00328\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00329\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00330\ }
\DoxyCodeLine{00331\ \ \ \ \ \}}
\DoxyCodeLine{00332\ }
\DoxyCodeLine{00333\ }
\DoxyCodeLine{00334\ }
\DoxyCodeLine{00335\ }
\DoxyCodeLine{00336\ }
\DoxyCodeLine{00337\ \};}
\DoxyCodeLine{00338\ }
\DoxyCodeLine{00339\ \textcolor{preprocessor}{\#endif\ }\textcolor{comment}{/*\ FACA\_HPP\ */}\textcolor{preprocessor}{}}

\end{DoxyCode}
